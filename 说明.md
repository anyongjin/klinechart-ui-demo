# 介绍
此项目提供Klinecharts的K线图和工具菜单。数据均来自ponentsoft.com。  

# 技术架构说明
本项目基于nuxt 3（vue3 ）  
```bash
# 安装项目
yarn install

# 开发模式运行
yarn dev

# 生成待发布打包文件
yarn build

# 生产环境运行（推荐）
pm2 start .output/server/index.mjs

# 生产环境运行（不推荐）
node .output/server/index.mjs
```

# 部署说明
1. 修改代码后执行`yarn build`生产待发布文件
2. 将`.output`压缩为`.output.zip`。
3. 通过winscp将`.output.zip`上传到服务器`/root`目录下
4. 解压缩：`unzip -o .ouput.zip`
5. 删除旧部署文件：`rm -rf klines`
6. 重命名文件夹：`mv .output klines`
7. 重启前端服务：`pm2 restart kline/server/index.mjs`
8. 默认将在3000端口提供前端服务。

## 项目整体架构说明
easyema.com网站是基于flask开发部署的，前端文件在`templates`中。服务器通过nginx对外提供服务。
修改nginx将`/kline`路径反向代理到本地3000端口，以便访问Klinecharts图表：
```text
    location ~ /(_nuxt|kline|fonts)\b {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
```
在目前的首页html中，嵌入了一个iframe，用于显示`/kline`页面。  
和外部通信通过`window.parent.postMessage`进行

## 对原python项目的改动
**/ponentstock/views/base_views.py**  
修改`IndexView.get`允许不登录访问首页  
**/static/js/src/watchlist.js**  
修改`countDatatableMaxHeight`支持右下角广告位  
**/static/js/src/klinecharts.js**  
新增以支持Klinecharts显示和外部沟通  
**/templates/chart/watchlist-sider.html**  
修改支持右下角广告位  
**/templates/index.html**  
修改支持Klinecharts显示  
